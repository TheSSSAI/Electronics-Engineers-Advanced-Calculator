# 1 Overview

## 1.1 Diagram Id

SEQ-OPS-002

## 1.2 Name

Distributed Logging with Correlation ID

## 1.3 Description

An incoming request to the API Gateway is assigned a unique Correlation ID (or the AWS X-Ray Trace ID). This ID is propagated through all downstream services (ECS, Lambda) in HTTP headers and is included in every structured JSON log message for that request, enabling end-to-end tracing in CloudWatch.

## 1.4 Type

üîπ OperationalFlow

## 1.5 Purpose

To enable effective troubleshooting and monitoring in a distributed system by allowing developers to trace the entire lifecycle of a single request across multiple services, as required by REQ-MON-001.

## 1.6 Complexity

Medium

## 1.7 Priority

üî¥ High

## 1.8 Frequency

OnDemand

## 1.9 Participants

- REPO-API-GATEWAY
- REPO-APP-USER-DATA
- REPO-APP-FORMULA-EXEC
- REPO-LOG-AGGREGATOR-CW

## 1.10 Key Interactions

- Client sends a request to the API Gateway.
- API Gateway (with X-Ray enabled) generates a Trace ID.
- API Gateway adds this ID to an `X-Amzn-Trace-Id` header before forwarding the request to a backend service.
- The backend service (NestJS middleware or Lambda handler) reads the header.
- The ID is added to the context of the structured logger (Pino).
- Every log message generated by the service for this request automatically includes the Correlation ID.
- All logs are streamed to Amazon CloudWatch Logs.

## 1.11 Triggers

- Any API request received by the API Gateway.

## 1.12 Outcomes

- A complete, traceable log of a single request is available in CloudWatch, queryable by the Correlation ID.

## 1.13 Business Rules

- The Correlation ID must be present in every log message.
- All logs must be in a structured JSON format.

## 1.14 Error Scenarios

- A service fails to propagate the header to a subsequent downstream call.
- A log message is generated without the ID due to an unhandled exception outside the request context.

## 1.15 Integration Points

- Amazon CloudWatch Logs
- AWS X-Ray

# 2.0 Details

## 2.1 Diagram Id

SEQ-OPS-002

## 2.2 Name

Implementation of Distributed Tracing and Logging with Correlation ID

## 2.3 Description

A detailed technical sequence showing how an incoming API request receives an AWS X-Ray Trace ID at the API Gateway, which is then propagated via the 'X-Amzn-Trace-Id' header to downstream services (ECS, Lambda). Services extract this ID, inject it into a request-scoped Pino logger context, and ensure all structured JSON log messages include it for end-to-end traceability in Amazon CloudWatch Logs, fulfilling REQ-MON-001.

## 2.4 Participants

### 2.4.1 Client Application

#### 2.4.1.1 Repository Id

REPO-CLIENT-SPA

#### 2.4.1.2 Display Name

Client (React SPA)

#### 2.4.1.3 Type

üîπ Client Application

#### 2.4.1.4 Technology

React/TypeScript

#### 2.4.1.5 Order

0

#### 2.4.1.6 Style

| Property | Value |
|----------|-------|
| Shape | actor |
| Color | #E0E0E0 |
| Stereotype | User Agent |

### 2.4.2.0 API Gateway

#### 2.4.2.1 Repository Id

REPO-API-GATEWAY

#### 2.4.2.2 Display Name

Amazon API Gateway

#### 2.4.2.3 Type

üîπ API Gateway

#### 2.4.2.4 Technology

AWS API Gateway v2 (HTTP)

#### 2.4.2.5 Order

1

#### 2.4.2.6 Style

| Property | Value |
|----------|-------|
| Shape | boundary |
| Color | #FF9900 |
| Stereotype | AWS Service |

### 2.4.3.0 Microservice

#### 2.4.3.1 Repository Id

REPO-APP-USER-DATA

#### 2.4.3.2 Display Name

User & Data Service

#### 2.4.3.3 Type

üîπ Microservice

#### 2.4.3.4 Technology

NestJS on AWS ECS Fargate

#### 2.4.3.5 Order

2

#### 2.4.3.6 Style

| Property | Value |
|----------|-------|
| Shape | component |
| Color | #232F3E |
| Stereotype | Container |

### 2.4.4.0 Log Aggregator

#### 2.4.4.1 Repository Id

REPO-LOG-AGGREGATOR-CW

#### 2.4.4.2 Display Name

Amazon CloudWatch Logs

#### 2.4.4.3 Type

üîπ Log Aggregator

#### 2.4.4.4 Technology

AWS CloudWatch

#### 2.4.4.5 Order

3

#### 2.4.4.6 Style

| Property | Value |
|----------|-------|
| Shape | database |
| Color | #5A6B86 |
| Stereotype | AWS Service |

## 2.5.0.0 Interactions

### 2.5.1.0 Request

#### 2.5.1.1 Source Id

REPO-CLIENT-SPA

#### 2.5.1.2 Target Id

REPO-API-GATEWAY

#### 2.5.1.3 Message

Sends API Request to create a custom mode with JWT for authentication.

#### 2.5.1.4 Sequence Number

1

#### 2.5.1.5 Type

üîπ Request

#### 2.5.1.6 Is Synchronous

‚úÖ Yes

#### 2.5.1.7 Return Message

Returns final HTTP response to the client.

#### 2.5.1.8 Has Return

‚úÖ Yes

#### 2.5.1.9 Is Activation

‚ùå No

#### 2.5.1.10 Technical Details

##### 2.5.1.10.1 Protocol

HTTPS/TLS 1.2+

##### 2.5.1.10.2 Method

POST /api/v1/modes

##### 2.5.1.10.3 Parameters

| Property | Value |
|----------|-------|
| Headers | {'Authorization': 'Bearer <jwt_token>', 'Content-Type': 'application/json'} |
| Body | { "name": "My Mode", "definition": { ... } } |

##### 2.5.1.10.4 Authentication

JWT validation is handled by the attached Cognito Authorizer on this route.

##### 2.5.1.10.5 Error Handling

Client handles 4xx/5xx responses.

##### 2.5.1.10.6 Performance

###### 2.5.1.10.6.1 Sla

N/A

### 2.5.2.0.0.0 Internal Processing

#### 2.5.2.1.0.0 Source Id

REPO-API-GATEWAY

#### 2.5.2.2.0.0 Target Id

REPO-API-GATEWAY

#### 2.5.2.3.0.0 Message

Generates AWS X-Ray Trace ID and initiates trace segment.

#### 2.5.2.4.0.0 Sequence Number

2

#### 2.5.2.5.0.0 Type

üîπ Internal Processing

#### 2.5.2.6.0.0 Is Synchronous

‚úÖ Yes

#### 2.5.2.7.0.0 Return Message



#### 2.5.2.8.0.0 Has Return

‚ùå No

#### 2.5.2.9.0.0 Is Activation

‚úÖ Yes

#### 2.5.2.10.0.0 Technical Details

##### 2.5.2.10.1.0 Protocol

Internal AWS Fabric

##### 2.5.2.10.2.0 Method

X-Ray Trace Initialization

##### 2.5.2.10.3.0 Parameters

Triggered by 'Active Tracing' being enabled on the API Gateway Stage.

##### 2.5.2.10.4.0 Authentication

N/A

##### 2.5.2.10.5.0 Error Handling

Managed by AWS.

##### 2.5.2.10.6.0 Performance

###### 2.5.2.10.6.1 Sla

Minimal overhead (<5ms)

### 2.5.3.0.0.0 Request

#### 2.5.3.1.0.0 Source Id

REPO-API-GATEWAY

#### 2.5.3.2.0.0 Target Id

REPO-APP-USER-DATA

#### 2.5.3.3.0.0 Message

Forwards request, injecting the X-Ray Trace ID into the 'X-Amzn-Trace-Id' header.

#### 2.5.3.4.0.0 Sequence Number

3

#### 2.5.3.5.0.0 Type

üîπ Request

#### 2.5.3.6.0.0 Is Synchronous

‚úÖ Yes

#### 2.5.3.7.0.0 Return Message

Returns '201 Created' from backend.

#### 2.5.3.8.0.0 Has Return

‚úÖ Yes

#### 2.5.3.9.0.0 Is Activation

‚ùå No

#### 2.5.3.10.0.0 Technical Details

##### 2.5.3.10.1.0 Protocol

HTTPS (via VPC Link)

##### 2.5.3.10.2.0 Method

POST /modes

##### 2.5.3.10.3.0 Parameters

| Property | Value |
|----------|-------|
| Headers | {'X-Amzn-Trace-Id': 'Root=1-5759e988-bd862e3fe1be46a994272793;Parent=...;Sampled=1'} |
| Body | Original request body is passed through. |

##### 2.5.3.10.4.0 Authentication

Original JWT is passed through; service trusts gateway validation.

##### 2.5.3.10.5.0 Error Handling

Returns 502/504 on backend failure.

##### 2.5.3.10.6.0 Performance

###### 2.5.3.10.6.1 Sla

Integration timeout configured at 29s.

### 2.5.4.0.0.0 Internal Processing

#### 2.5.4.1.0.0 Source Id

REPO-APP-USER-DATA

#### 2.5.4.2.0.0 Target Id

REPO-APP-USER-DATA

#### 2.5.4.3.0.0 Message

NestJS Middleware/Interceptor extracts 'X-Amzn-Trace-Id' from headers.

#### 2.5.4.4.0.0 Sequence Number

4

#### 2.5.4.5.0.0 Type

üîπ Internal Processing

#### 2.5.4.6.0.0 Is Synchronous

‚úÖ Yes

#### 2.5.4.7.0.0 Return Message



#### 2.5.4.8.0.0 Has Return

‚ùå No

#### 2.5.4.9.0.0 Is Activation

‚úÖ Yes

#### 2.5.4.10.0.0 Technical Details

##### 2.5.4.10.1.0 Protocol

In-Process

##### 2.5.4.10.2.0 Method

LoggerMiddleware.use()

##### 2.5.4.10.3.0 Parameters

NestJS `Request` object.

##### 2.5.4.10.4.0 Authentication

N/A

##### 2.5.4.10.5.0 Error Handling

If header is missing, generates a UUIDv4 as a fallback correlationId.

##### 2.5.4.10.6.0 Performance

###### 2.5.4.10.6.1 Sla

Sub-millisecond operation.

### 2.5.5.0.0.0 Internal Processing

#### 2.5.5.1.0.0 Source Id

REPO-APP-USER-DATA

#### 2.5.5.2.0.0 Target Id

REPO-APP-USER-DATA

#### 2.5.5.3.0.0 Message

Creates a request-scoped logger instance with the Correlation ID.

#### 2.5.5.4.0.0 Sequence Number

5

#### 2.5.5.5.0.0 Type

üîπ Internal Processing

#### 2.5.5.6.0.0 Is Synchronous

‚úÖ Yes

#### 2.5.5.7.0.0 Return Message



#### 2.5.5.8.0.0 Has Return

‚ùå No

#### 2.5.5.9.0.0 Is Activation

‚ùå No

#### 2.5.5.10.0.0 Technical Details

##### 2.5.5.10.1.0 Protocol

In-Process

##### 2.5.5.10.2.0 Method

pino.child()

##### 2.5.5.10.3.0 Parameters

Binds the extracted trace ID to the logger context: `bindings: { correlationId: '...' }`

##### 2.5.5.10.4.0 Authentication

N/A

##### 2.5.5.10.5.0 Error Handling

Handled by Pino library.

##### 2.5.5.10.6.0 Performance

###### 2.5.5.10.6.1 Sla

Low overhead.

### 2.5.6.0.0.0 Asynchronous Message

#### 2.5.6.1.0.0 Source Id

REPO-APP-USER-DATA

#### 2.5.6.2.0.0 Target Id

REPO-LOG-AGGREGATOR-CW

#### 2.5.6.3.0.0 Message

Streams structured log entry to CloudWatch Log Stream.

#### 2.5.6.4.0.0 Sequence Number

6

#### 2.5.6.5.0.0 Type

üîπ Asynchronous Message

#### 2.5.6.6.0.0 Is Synchronous

‚ùå No

#### 2.5.6.7.0.0 Return Message



#### 2.5.6.8.0.0 Has Return

‚ùå No

#### 2.5.6.9.0.0 Is Activation

‚ùå No

#### 2.5.6.10.0.0 Technical Details

##### 2.5.6.10.1.0 Protocol

awslogs driver

##### 2.5.6.10.2.0 Method

logs:PutLogEvents

##### 2.5.6.10.3.0 Parameters

| Property | Value |
|----------|-------|
| Log Event | { "level": 30, "time": 1672531200000, "correlation... |

##### 2.5.6.10.4.0 Authentication

Assumed IAM Role for ECS Task.

##### 2.5.6.10.5.0 Error Handling

Log driver handles retries. Failures are logged to container stderr.

##### 2.5.6.10.6.0 Performance

###### 2.5.6.10.6.1 Sla

Asynchronous; does not impact API response time.

### 2.5.7.0.0.0 Internal Processing

#### 2.5.7.1.0.0 Source Id

REPO-APP-USER-DATA

#### 2.5.7.2.0.0 Target Id

REPO-APP-USER-DATA

#### 2.5.7.3.0.0 Message

Executes business logic in controller/service.

#### 2.5.7.4.0.0 Sequence Number

7

#### 2.5.7.5.0.0 Type

üîπ Internal Processing

#### 2.5.7.6.0.0 Is Synchronous

‚úÖ Yes

#### 2.5.7.7.0.0 Return Message



#### 2.5.7.8.0.0 Has Return

‚ùå No

#### 2.5.7.9.0.0 Is Activation

‚ùå No

#### 2.5.7.10.0.0 Technical Details

##### 2.5.7.10.1.0 Protocol

In-Process

##### 2.5.7.10.2.0 Method

CustomModeService.create()

##### 2.5.7.10.3.0 Parameters

DTO from request body.

##### 2.5.7.10.4.0 Authentication

N/A

##### 2.5.7.10.5.0 Error Handling

Exceptions are caught by a global filter which uses the request-scoped logger to log the stack trace with the correlationId.

##### 2.5.7.10.6.0 Performance

###### 2.5.7.10.6.1 Sla

Business logic execution time.

## 2.6.0.0.0.0 Notes

### 2.6.1.0.0.0 Content

#### 2.6.1.1.0.0 Content

AWS X-Ray 'Active Tracing' must be enabled in the API Gateway stage configuration. This is the source of the Trace ID.

#### 2.6.1.2.0.0 Position

Top

#### 2.6.1.3.0.0 Participant Id

REPO-API-GATEWAY

#### 2.6.1.4.0.0 Sequence Number

2

### 2.6.2.0.0.0 Content

#### 2.6.2.1.0.0 Content

The 'nestjs-pino' library should be configured with a request-scoped provider to ensure each request gets a unique logger instance with the correct correlationId.

#### 2.6.2.2.0.0 Position

Middle

#### 2.6.2.3.0.0 Participant Id

REPO-APP-USER-DATA

#### 2.6.2.4.0.0 Sequence Number

5

### 2.6.3.0.0.0 Content

#### 2.6.3.1.0.0 Content

Log streams from ECS containers and Lambda functions are automatically sent to CloudWatch. The ECS Task Definition must specify the 'awslogs' driver and the target log group.

#### 2.6.3.2.0.0 Position

Bottom

#### 2.6.3.3.0.0 Participant Id

REPO-LOG-AGGREGATOR-CW

#### 2.6.3.4.0.0 Sequence Number

6

## 2.7.0.0.0.0 Implementation Guidance

| Property | Value |
|----------|-------|
| Security Requirements | The IAM Role for the ECS Task requires `logs:Creat... |
| Performance Targets | The logging middleware/interceptor must add less t... |
| Error Handling Strategy | A global NestJS exception filter must be implement... |
| Testing Considerations | Integration tests should send a request with a kno... |
| Monitoring Requirements | A CloudWatch Metric Filter should be created on th... |
| Deployment Considerations | All related infrastructure (CloudWatch Log Groups,... |

