# 1 Overview

## 1.1 Diagram Id

SEQ-UJ-001

## 1.2 Name

Create a Custom Calculation Mode

## 1.3 Description

A logged-in user follows a multi-step wizard in the client application to define a new custom calculation mode. The wizard guides them through naming, defining variables, and writing formulas. Upon completion, the entire mode definition is sent to the backend and saved.

## 1.4 Type

üîπ UserJourney

## 1.5 Purpose

To provide the primary user flow for the application's user-extensible functionality, enabling users to create and persist their own custom tools.

## 1.6 Complexity

Medium

## 1.7 Priority

üö® Critical

## 1.8 Frequency

OnDemand

## 1.9 Participants

- REPO-SPA-CLIENT
- REPO-API-GATEWAY
- REPO-APP-USER-DATA
- REPO-DB-POSTGRES

## 1.10 Key Interactions

- User navigates through the creation wizard UI, providing metadata, variables, and formulas.
- The Client SPA provides real-time syntax validation for formulas.
- On final save, the Client SPA sends a single authenticated POST request to the '/modes' endpoint with the complete mode definition in the request body.
- API Gateway validates the user's JWT and routes the request.
- The User & Data Service validates the incoming data structure.
- A new record with the mode definition stored in a JSONB field is created in the `custom_modes` table in PostgreSQL.

## 1.11 Triggers

- User clicks the 'Create New Mode' button and completes the wizard.

## 1.12 Outcomes

- A new custom mode is created and associated with the user.
- The new mode is immediately available in the user's list of custom modes.

## 1.13 Business Rules

- A custom mode name must be unique for a given user.
- The mode definition must conform to the required JSON schema.

## 1.14 Error Scenarios

- User provides a name that is already in use.
- The mode definition is malformed or fails validation.
- The API call fails due to a network or server error.

## 1.15 Integration Points

*No items available*

# 2.0 Details

## 2.1 Diagram Id

SEQ-UJ-001

## 2.2 Name

User Journey: Create a Custom Calculation Mode

## 2.3 Description

Implementation sequence for the end-to-end user journey of creating a new custom calculation mode. This diagram covers the client-side wizard interaction, state management, API submission, backend validation, and data persistence. It details both the successful creation path and critical error handling scenarios.

## 2.4 Participants

### 2.4.1 Frontend Application

#### 2.4.1.1 Repository Id

REPO-SPA-CLIENT

#### 2.4.1.2 Display Name

Client: React SPA

#### 2.4.1.3 Type

üîπ Frontend Application

#### 2.4.1.4 Technology

React 18, TypeScript, Redux Toolkit, Vite

#### 2.4.1.5 Order

1

#### 2.4.1.6 Style

| Property | Value |
|----------|-------|
| Shape | actor |
| Color | #1E90FF |
| Stereotype | UI/Client |

### 2.4.2.0 API Gateway

#### 2.4.2.1 Repository Id

REPO-API-GATEWAY

#### 2.4.2.2 Display Name

API Gateway

#### 2.4.2.3 Type

üîπ API Gateway

#### 2.4.2.4 Technology

Amazon API Gateway

#### 2.4.2.5 Order

2

#### 2.4.2.6 Style

| Property | Value |
|----------|-------|
| Shape | boundary |
| Color | #FF8C00 |
| Stereotype | Gateway |

### 2.4.3.0 Microservice

#### 2.4.3.1 Repository Id

REPO-APP-USER-DATA

#### 2.4.3.2 Display Name

User & Data Service

#### 2.4.3.3 Type

üîπ Microservice

#### 2.4.3.4 Technology

NestJS, Node.js, TypeORM

#### 2.4.3.5 Order

3

#### 2.4.3.6 Style

| Property | Value |
|----------|-------|
| Shape | control |
| Color | #9370DB |
| Stereotype | Service |

### 2.4.4.0 Database

#### 2.4.4.1 Repository Id

REPO-DB-POSTGRES

#### 2.4.4.2 Display Name

Database

#### 2.4.4.3 Type

üîπ Database

#### 2.4.4.4 Technology

PostgreSQL 15+

#### 2.4.4.5 Order

4

#### 2.4.4.6 Style

| Property | Value |
|----------|-------|
| Shape | database |
| Color | #32CD32 |
| Stereotype | Persistence |

## 2.5.0.0 Interactions

### 2.5.1.0 User Interaction Loop

#### 2.5.1.1 Source Id

REPO-SPA-CLIENT

#### 2.5.1.2 Target Id

REPO-SPA-CLIENT

#### 2.5.1.3 Message

User navigates wizard, enters mode details (name, variables, formulas). Client performs real-time input validation (e.g., required fields, formula syntax).

#### 2.5.1.4 Sequence Number

1

#### 2.5.1.5 Type

üîπ User Interaction Loop

#### 2.5.1.6 Is Synchronous

‚úÖ Yes

#### 2.5.1.7 Return Message



#### 2.5.1.8 Has Return

‚ùå No

#### 2.5.1.9 Is Activation

‚úÖ Yes

#### 2.5.1.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | N/A |
| Method | handleInputChange, validateFormula |
| Parameters | Form field values |
| Authentication | N/A (Client-side) |
| Error Handling | Display inline error messages on form fields. |
| Performance | UI updates should be < 50ms. |

### 2.5.2.0 API Request

#### 2.5.2.1 Source Id

REPO-SPA-CLIENT

#### 2.5.2.2 Target Id

REPO-API-GATEWAY

#### 2.5.2.3 Message

On final 'Save', sends new mode definition.

#### 2.5.2.4 Sequence Number

2

#### 2.5.2.5 Type

üîπ API Request

#### 2.5.2.6 Is Synchronous

‚úÖ Yes

#### 2.5.2.7 Return Message

Returns success (201) or error (4xx/5xx) response.

#### 2.5.2.8 Has Return

‚úÖ Yes

#### 2.5.2.9 Is Activation

‚úÖ Yes

#### 2.5.2.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | HTTPS |
| Method | POST /api/v1/modes |
| Parameters | Request Body: CreateCustomModeDTO { name: string, ... |
| Authentication | Requires JWT Bearer token in 'Authorization' heade... |
| Error Handling | Handles 400, 401, 409, 500 HTTP responses. |
| Performance | API call initiated, client displays loading state. |

### 2.5.3.0 Service Invocation

#### 2.5.3.1 Source Id

REPO-API-GATEWAY

#### 2.5.3.2 Target Id

REPO-APP-USER-DATA

#### 2.5.3.3 Message

Validates JWT with Cognito Authorizer and routes request.

#### 2.5.3.4 Sequence Number

3

#### 2.5.3.5 Type

üîπ Service Invocation

#### 2.5.3.6 Is Synchronous

‚úÖ Yes

#### 2.5.3.7 Return Message

Forwards backend service response.

#### 2.5.3.8 Has Return

‚úÖ Yes

#### 2.5.3.9 Is Activation

‚úÖ Yes

#### 2.5.3.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | HTTPS (VPC Link) |
| Method | POST /modes |
| Parameters | Forwards request body and headers. |
| Authentication | Cognito Authorizer validates JWT signature, expiry... |
| Error Handling | Propagates Correlation ID in 'X-Correlation-ID' he... |
| Performance | Adds < 50ms latency. |

### 2.5.4.0 Database Query

#### 2.5.4.1 Source Id

REPO-APP-USER-DATA

#### 2.5.4.2 Target Id

REPO-DB-POSTGRES

#### 2.5.4.3 Message

Check for existing mode with same name for the user.

#### 2.5.4.4 Sequence Number

4

#### 2.5.4.5 Type

üîπ Database Query

#### 2.5.4.6 Is Synchronous

‚úÖ Yes

#### 2.5.4.7 Return Message

Returns count of matching records.

#### 2.5.4.8 Has Return

‚úÖ Yes

#### 2.5.4.9 Is Activation

‚úÖ Yes

#### 2.5.4.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | TCP/IP (PostgreSQL Wire Protocol) |
| Method | SQL SELECT |
| Parameters | SELECT COUNT(*) FROM custom_modes WHERE user_id = ... |
| Authentication | Uses credentials from AWS Secrets Manager. |
| Error Handling | Handled by TypeORM, can throw connection or query ... |
| Performance | Query must be indexed on (user_id, name) for high ... |

### 2.5.5.0 Database Command

#### 2.5.5.1 Source Id

REPO-APP-USER-DATA

#### 2.5.5.2 Target Id

REPO-DB-POSTGRES

#### 2.5.5.3 Message

If name is unique, insert new mode record.

#### 2.5.5.4 Sequence Number

5

#### 2.5.5.5 Type

üîπ Database Command

#### 2.5.5.6 Is Synchronous

‚úÖ Yes

#### 2.5.5.7 Return Message

Returns the newly created record.

#### 2.5.5.8 Has Return

‚úÖ Yes

#### 2.5.5.9 Is Activation

‚ùå No

#### 2.5.5.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | TCP/IP (PostgreSQL Wire Protocol) |
| Method | SQL INSERT |
| Parameters | INSERT INTO custom_modes (user_id, name, descripti... |
| Authentication | Uses credentials from AWS Secrets Manager. |
| Error Handling | Database enforces unique constraint (user_id, name... |
| Performance | Primary key insertion is fast. |

### 2.5.6.0 API Success Response

#### 2.5.6.1 Source Id

REPO-APP-USER-DATA

#### 2.5.6.2 Target Id

REPO-API-GATEWAY

#### 2.5.6.3 Message

Return 201 Created with new mode data.

#### 2.5.6.4 Sequence Number

6

#### 2.5.6.5 Type

üîπ API Success Response

#### 2.5.6.6 Is Synchronous

‚úÖ Yes

#### 2.5.6.7 Return Message



#### 2.5.6.8 Has Return

‚ùå No

#### 2.5.6.9 Is Activation

‚ùå No

#### 2.5.6.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | HTTPS |
| Method | HTTP/1.1 201 Created |
| Parameters | Response Body: CustomModeDTO { id, name, ... } |
| Authentication | N/A |
| Error Handling | N/A |
| Performance | Serialization of response DTO. |

#### 2.5.6.11 Nested Interactions

##### 2.5.6.11.1 API Error Response

###### 2.5.6.11.1.1 Source Id

REPO-APP-USER-DATA

###### 2.5.6.11.1.2 Target Id

REPO-API-GATEWAY

###### 2.5.6.11.1.3 Message

[ALT: Duplicate Name] Return 409 Conflict.

###### 2.5.6.11.1.4 Sequence Number

6a

###### 2.5.6.11.1.5 Type

üîπ API Error Response

###### 2.5.6.11.1.6 Is Synchronous

‚úÖ Yes

###### 2.5.6.11.1.7 Has Return

‚ùå No

###### 2.5.6.11.1.8 Technical Details

| Property | Value |
|----------|-------|
| Protocol | HTTPS |
| Method | HTTP/1.1 409 Conflict |
| Parameters | Response Body: { statusCode: 409, message: 'A mode... |
| Authentication | N/A |
| Error Handling | Triggered if query at step 4 returns count > 0. |

##### 2.5.6.11.2.0 API Error Response

###### 2.5.6.11.2.1 Source Id

REPO-APP-USER-DATA

###### 2.5.6.11.2.2 Target Id

REPO-API-GATEWAY

###### 2.5.6.11.2.3 Message

[ALT: Validation Error] Return 400 Bad Request.

###### 2.5.6.11.2.4 Sequence Number

6b

###### 2.5.6.11.2.5 Type

üîπ API Error Response

###### 2.5.6.11.2.6 Is Synchronous

‚úÖ Yes

###### 2.5.6.11.2.7 Has Return

‚ùå No

###### 2.5.6.11.2.8 Technical Details

| Property | Value |
|----------|-------|
| Protocol | HTTPS |
| Method | HTTP/1.1 400 Bad Request |
| Parameters | Response Body: { statusCode: 400, message: ['name ... |
| Authentication | N/A |
| Error Handling | Triggered by NestJS ValidationPipe if DTO is malfo... |

### 2.5.7.0.0.0 API Success Response

#### 2.5.7.1.0.0 Source Id

REPO-API-GATEWAY

#### 2.5.7.2.0.0 Target Id

REPO-SPA-CLIENT

#### 2.5.7.3.0.0 Message

Forward 201 Created response.

#### 2.5.7.4.0.0 Sequence Number

7

#### 2.5.7.5.0.0 Type

üîπ API Success Response

#### 2.5.7.6.0.0 Is Synchronous

‚úÖ Yes

#### 2.5.7.7.0.0 Return Message



#### 2.5.7.8.0.0 Has Return

‚ùå No

#### 2.5.7.9.0.0 Is Activation

‚ùå No

#### 2.5.7.10.0.0 Technical Details

| Property | Value |
|----------|-------|
| Protocol | HTTPS |
| Method | HTTP/1.1 201 Created |
| Parameters | Forwards backend response body. |
| Authentication | N/A |
| Error Handling | N/A |
| Performance | Minimal latency added. |

### 2.5.8.0.0.0 UI State Update

#### 2.5.8.1.0.0 Source Id

REPO-SPA-CLIENT

#### 2.5.8.2.0.0 Target Id

REPO-SPA-CLIENT

#### 2.5.8.3.0.0 Message

On success, update Redux state, hide loading spinner, show success notification, and navigate to modes list.

#### 2.5.8.4.0.0 Sequence Number

8

#### 2.5.8.5.0.0 Type

üîπ UI State Update

#### 2.5.8.6.0.0 Is Synchronous

‚úÖ Yes

#### 2.5.8.7.0.0 Return Message



#### 2.5.8.8.0.0 Has Return

‚ùå No

#### 2.5.8.9.0.0 Is Activation

‚ùå No

#### 2.5.8.10.0.0 Technical Details

| Property | Value |
|----------|-------|
| Protocol | N/A |
| Method | dispatch(addCustomMode(response.data)) |
| Parameters | New mode object from API response. |
| Authentication | N/A |
| Error Handling | On 409/400 error responses, displays specific erro... |
| Performance | UI should feel responsive, reflecting the new stat... |

## 2.6.0.0.0.0 Notes

### 2.6.1.0.0.0 Content

#### 2.6.1.1.0.0 Content

The multi-step wizard is managed entirely client-side. Its state is held in a local React component state or a dedicated Redux slice until the final submission.

#### 2.6.1.2.0.0 Position

top-left

#### 2.6.1.3.0.0 Participant Id

REPO-SPA-CLIENT

#### 2.6.1.4.0.0 Sequence Number

1

### 2.6.2.0.0.0 Content

#### 2.6.2.1.0.0 Content

Client-side form validation provides immediate user feedback, but authoritative validation is always performed on the backend to ensure data integrity.

#### 2.6.2.2.0.0 Position

middle

#### 2.6.2.3.0.0 Participant Id

REPO-SPA-CLIENT

#### 2.6.2.4.0.0 Sequence Number

2

### 2.6.3.0.0.0 Content

#### 2.6.3.1.0.0 Content

The 'definition' field in the database is of type JSONB, which allows for efficient querying of the nested JSON structure if needed in the future.

#### 2.6.3.2.0.0 Position

bottom-right

#### 2.6.3.3.0.0 Participant Id

REPO-DB-POSTGRES

#### 2.6.3.4.0.0 Sequence Number

5

## 2.7.0.0.0.0 Implementation Guidance

| Property | Value |
|----------|-------|
| Security Requirements | The API endpoint `/modes` must be protected by the... |
| Performance Targets | The entire end-to-end process from clicking 'Save'... |
| Error Handling Strategy | The client should handle specific 4xx error codes ... |
| Testing Considerations | E2E tests should cover the full wizard flow and su... |
| Monitoring Requirements | Monitor the latency and error rate (4xx/5xx) of th... |
| Deployment Considerations | Any changes to the `custom_modes` table schema mus... |

