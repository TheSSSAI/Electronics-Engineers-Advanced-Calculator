# 1 System Overview

## 1.1 Analysis Date

2025-06-13

## 1.2 Architecture Type

Synchronous Microservices with Serverless Component

## 1.3 Technology Stack

- AWS ECS
- AWS Lambda
- Amazon API Gateway
- Amazon RDS (PostgreSQL)
- AWS Cognito

## 1.4 Bounded Contexts

- User & Account Management
- Calculation Engine
- Custom Mode Management

# 2.0 Project Specific Events

- {'eventId': 'EVT-USR-001', 'eventName': 'UserAccountDeleted', 'eventType': 'system', 'category': 'Identity & Access', 'description': "Fired after a user's account and all associated data have been successfully and permanently deleted from the primary database. This is a post-facto notification for potential auditing or integration with external systems, not part of the core deletion transaction.", 'triggerCondition': 'Successful completion of the synchronous user data deletion process in the User & Data Service, as initiated by REQ-1-031.', 'sourceContext': 'User & Data Service', 'targetContexts': ['Auditing Service (Future)', 'Analytics Service (Future)'], 'payload': {'schema': {'userId': 'string (UUID)', 'authProviderId': 'string', 'email': 'string', 'deletedAt': 'string (ISO 8601 Timestamp)'}, 'requiredFields': ['userId', 'authProviderId', 'deletedAt'], 'optionalFields': ['email']}, 'frequency': 'low', 'businessCriticality': 'normal', 'dataSource': {'database': 'Amazon RDS (PostgreSQL)', 'table': 'users', 'operation': 'delete'}, 'routing': {'routingKey': 'user.account.deleted', 'exchange': 'N/A (Direct to SNS Topic)', 'queue': 'N/A'}, 'consumers': [{'service': 'Logging/Auditing Lambda (Future)', 'handler': 'N/A', 'processingType': 'async'}], 'dependencies': ['REQ-1-031', 'REQ-1-061'], 'errorHandling': {'retryStrategy': 'Handled by SNS/SQS default retry mechanism', 'deadLetterQueue': 'audit-log-dlq (SQS)', 'timeoutMs': 5000}}

# 3.0 Event Types And Schema Design

## 3.1 Essential Event Types

- {'eventName': 'UserAccountDeleted', 'category': 'system', 'description': 'The only necessary event for the current scope, used to decouple post-deletion actions (like logging) from the primary user transaction. This avoids adding latency to the user-facing deletion API call.', 'priority': 'low'}

## 3.2 Schema Design

| Property | Value |
|----------|-------|
| Format | JSON |
| Reasoning | Simple, human-readable, and natively supported by ... |
| Consistency Approach | A single event type is defined; consistency is not... |

## 3.3 Schema Evolution

| Property | Value |
|----------|-------|
| Backward Compatibility | ‚úÖ |
| Forward Compatibility | ‚ùå |
| Strategy | Not a primary concern for the current scope. If re... |

## 3.4 Event Structure

### 3.4.1 Standard Fields

- eventId
- eventVersion
- eventName
- timestamp
- correlationId
- source

### 3.4.2 Metadata Requirements

- The Correlation ID generated by the API Gateway must be included in the event metadata to allow tracing the event back to the original API request.

# 4.0.0 Event Routing And Processing

## 4.1.0 Routing Mechanisms

### 4.1.1 Synchronous API Call (Primary)

#### 4.1.1.1 Type

üîπ Synchronous API Call (Primary)

#### 4.1.1.2 Description

The system's core architecture is synchronous request/response via Amazon API Gateway. This is not event-driven but is the primary communication pattern.

#### 4.1.1.3 Use Case

All client-to-backend and inter-service communication for core features.

### 4.1.2.0 AWS SNS (Topic)

#### 4.1.2.1 Type

üîπ AWS SNS (Topic)

#### 4.1.2.2 Description

For the single `UserAccountDeleted` event, the User & Data Service will publish a message to a dedicated SNS topic. This provides a simple, scalable, and decoupled fan-out mechanism.

#### 4.1.2.3 Use Case

Notifying potential downstream systems (out of current scope) of user deletion without blocking the main service.

## 4.2.0.0 Processing Patterns

- {'pattern': 'sequential', 'applicableScenarios': ['All current business logic is handled through sequential, synchronous API calls. There is no requirement for complex event-driven workflows like Sagas.'], 'implementation': 'Standard RESTful controllers and services within the NestJS application.'}

## 4.3.0.0 Filtering And Subscription

### 4.3.1.0 Filtering Mechanism

Not required. With a single event and a dedicated topic, no filtering is necessary.

### 4.3.2.0 Subscription Model

SNS Topic with SQS queue subscriptions for durable, at-least-once delivery to consumers.

### 4.3.3.0 Routing Keys

*No items available*

## 4.4.0.0 Handler Isolation

| Property | Value |
|----------|-------|
| Required | ‚úÖ |
| Approach | AWS Lambda functions for event consumers. |
| Reasoning | Lambda provides complete isolation of compute, sec... |

## 4.5.0.0 Delivery Guarantees

| Property | Value |
|----------|-------|
| Level | at-least-once |
| Justification | For an audit or logging event, processing it more ... |
| Implementation | Using an SQS queue as a subscriber to the SNS topi... |

# 5.0.0.0 Event Storage And Replay

## 5.1.0.0 Persistence Requirements

| Property | Value |
|----------|-------|
| Required | ‚ùå |
| Duration | N/A |
| Reasoning | The system is not event-sourced. The PostgreSQL da... |

## 5.2.0.0 Event Sourcing

### 5.2.1.0 Necessary

‚ùå No

### 5.2.2.0 Justification

The application's state is relational and best managed in a traditional database. The business logic is based on current state (CRUD), not a series of historical events.

### 5.2.3.0 Scope

*No items available*

## 5.3.0.0 Technology Options

*No items available*

## 5.4.0.0 Replay Capabilities

### 5.4.1.0 Required

‚ùå No

### 5.4.2.0 Scenarios

*No items available*

### 5.4.3.0 Implementation

N/A

## 5.5.0.0 Retention Policy

| Property | Value |
|----------|-------|
| Strategy | No event store exists. Data retention is governed ... |
| Duration | N/A |
| Archiving Approach | N/A |

# 6.0.0.0 Dead Letter Queue And Error Handling

## 6.1.0.0 Dead Letter Strategy

| Property | Value |
|----------|-------|
| Approach | A dedicated SQS Dead Letter Queue (DLQ) will be co... |
| Queue Configuration | Standard SQS queue with a message retention period... |
| Processing Logic | Failed messages will be moved to the DLQ after the... |

## 6.2.0.0 Retry Policies

- {'errorType': 'Any consumer Lambda error', 'maxRetries': 3, 'backoffStrategy': 'exponential', 'delayConfiguration': 'Default AWS SQS retry configuration.'}

## 6.3.0.0 Poison Message Handling

| Property | Value |
|----------|-------|
| Detection Mechanism | Repeated failures leading to message being sent to... |
| Handling Strategy | Alerting on messages in the DLQ for manual investi... |
| Alerting Required | ‚úÖ |

## 6.4.0.0 Error Notification

### 6.4.1.0 Channels

- Amazon CloudWatch Alarm -> SNS -> Email

### 6.4.2.0 Severity

warning

### 6.4.3.0 Recipients

- Development Team

## 6.5.0.0 Recovery Procedures

- {'scenario': 'Message in DLQ due to transient error', 'procedure': "Use AWS SQS console's 'Start DLQ redrive' feature to move messages back to the source queue for reprocessing after the issue is resolved.", 'automationLevel': 'manual'}

# 7.0.0.0 Event Versioning Strategy

## 7.1.0.0 Schema Evolution Approach

| Property | Value |
|----------|-------|
| Strategy | Not required for the current scope due to having o... |
| Versioning Scheme | N/A |
| Migration Strategy | N/A |

## 7.2.0.0 Compatibility Requirements

| Property | Value |
|----------|-------|
| Backward Compatible | ‚ùå |
| Forward Compatible | ‚ùå |
| Reasoning | Not applicable at this stage. |

## 7.3.0.0 Version Identification

| Property | Value |
|----------|-------|
| Mechanism | N/A |
| Location | header |
| Format | N/A |

## 7.4.0.0 Consumer Upgrade Strategy

| Property | Value |
|----------|-------|
| Approach | N/A |
| Rollout Strategy | N/A |
| Rollback Procedure | N/A |

## 7.5.0.0 Schema Registry

| Property | Value |
|----------|-------|
| Required | ‚ùå |
| Technology | N/A |
| Governance | N/A |

# 8.0.0.0 Event Monitoring And Observability

## 8.1.0.0 Monitoring Capabilities

### 8.1.1.0 Capability

#### 8.1.1.1 Capability

DLQ message count monitoring

#### 8.1.1.2 Justification

Essential for detecting event processing failures.

#### 8.1.1.3 Implementation

CloudWatch Alarm on the `ApproximateNumberOfMessagesVisible` metric for the DLQ SQS queue.

### 8.1.2.0 Capability

#### 8.1.2.1 Capability

SNS Topic publish failures

#### 8.1.2.2 Justification

Detects issues with the event producer (User & Data Service).

#### 8.1.2.3 Implementation

CloudWatch metrics for the SNS topic.

## 8.2.0.0 Tracing And Correlation

| Property | Value |
|----------|-------|
| Tracing Required | ‚úÖ |
| Correlation Strategy | Use the Correlation ID from the originating API re... |
| Trace Id Propagation | The User & Data Service must extract the Correlati... |

## 8.3.0.0 Performance Metrics

- {'metric': 'SQS Consumer Lambda processing latency', 'threshold': '> 1000ms (P95)', 'alerting': True}

## 8.4.0.0 Event Flow Visualization

| Property | Value |
|----------|-------|
| Required | ‚ùå |
| Tooling | N/A |
| Scope | The event flow is extremely simple (1 producer, 1 ... |

## 8.5.0.0 Alerting Requirements

- {'condition': 'Any message appears in the UserAccountDeleted DLQ.', 'severity': 'warning', 'responseTime': '24 hours', 'escalationPath': ['Development Team']}

# 9.0.0.0 Implementation Priority

## 9.1.0.0 Component

### 9.1.1.0 Component

UserAccountDeleted Event Publishing

### 9.1.2.0 Priority

üü¢ low

### 9.1.3.0 Dependencies

- User & Data Service

### 9.1.4.0 Estimated Effort

Low

## 9.2.0.0 Component

### 9.2.1.0 Component

SNS Topic and SQS/DLQ Infrastructure

### 9.2.2.0 Priority

üü¢ low

### 9.2.3.0 Dependencies

*No items available*

### 9.2.4.0 Estimated Effort

Very Low (via Terraform)

# 10.0.0.0 Risk Assessment

- {'risk': 'Over-engineering with unnecessary eventing.', 'impact': 'medium', 'probability': 'high', 'mitigation': 'Strictly adhere to the current synchronous architecture. Do not introduce a message broker or complex event patterns until a specific business requirement justifies the added cost and complexity.'}

# 11.0.0.0 Recommendations

## 11.1.0.0 Category

### 11.1.1.0 Category

üîπ Architecture

### 11.1.2.0 Recommendation

Defer implementation of a full-fledged event-driven architecture.

### 11.1.3.0 Justification

The system requirements are fully met by a simpler, cheaper, and easier-to-maintain synchronous request/response architecture. Introducing an event bus (e.g., EventBridge) would add significant complexity and operational overhead with no current benefit.

### 11.1.4.0 Priority

üî¥ high

## 11.2.0.0 Category

### 11.2.1.0 Category

üîπ Implementation

### 11.2.2.0 Recommendation

Implement the `UserAccountDeleted` event as a simple, fire-and-forget notification to an SNS topic.

### 11.2.3.0 Justification

This provides a clean decoupling point for future, non-transactional needs like auditing, without complicating the core business logic of the User & Data Service. It is a low-effort, high-value addition for future extensibility.

### 11.2.4.0 Priority

üü¢ low

